#!/usr/bin/env python3
"""
Script para generar PDF del an√°lisis arquitect√≥nico
Convierte el archivo Markdown a PDF usando reportlab
"""

import os
import sys
from datetime import datetime
from pathlib import Path

def create_pdf_analysis():
    """Crea PDF del an√°lisis usando reportlab si est√° disponible"""
    
    try:
        from reportlab.lib.pagesizes import letter, A4
        from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
        from reportlab.lib.units import inch
        from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak
        from reportlab.lib.enums import TA_LEFT, TA_CENTER, TA_JUSTIFY
    except ImportError:
        print("‚ùå ReportLab no est√° instalado.")
        print("üí° Instalar con: pip install reportlab")
        return False
    
    # Configurar archivo de salida
    output_file = "ANALISIS_ARQUITECTONICO_VOICEFLOW_POC.pdf"
    
    # Leer contenido del an√°lisis
    try:
        with open("ANALISIS_ARQUITECTONICO_COMPLETO.md", "r", encoding="utf-8") as f:
            content = f.read()
    except FileNotFoundError:
        print("‚ùå No se encontr√≥ el archivo ANALISIS_ARQUITECTONICO_COMPLETO.md")
        return False
    
    # Crear documento PDF
    doc = SimpleDocTemplate(output_file, pagesize=A4,
                          rightMargin=72, leftMargin=72,
                          topMargin=72, bottomMargin=18)
    
    # Configurar estilos
    styles = getSampleStyleSheet()
    
    # Estilo personalizado para t√≠tulos
    title_style = ParagraphStyle(
        'CustomTitle',
        parent=styles['Heading1'],
        fontSize=18,
        spaceAfter=30,
        alignment=TA_CENTER,
        textColor='#2c3e50'
    )
    
    # Estilo para subt√≠tulos
    subtitle_style = ParagraphStyle(
        'CustomSubtitle',
        parent=styles['Heading2'],
        fontSize=14,
        spaceAfter=20,
        textColor='#34495e'
    )
    
    # Estilo para texto normal
    normal_style = ParagraphStyle(
        'CustomNormal',
        parent=styles['Normal'],
        fontSize=10,
        alignment=TA_JUSTIFY,
        spaceAfter=12
    )
    
    # Crear lista de elementos para el PDF
    story = []
    
    # Procesar contenido l√≠nea por l√≠nea
    lines = content.split('\n')
    
    for line in lines:
        line = line.strip()
        
        if not line:  # L√≠nea vac√≠a
            story.append(Spacer(1, 6))
            continue
            
        # T√≠tulos principales (# )
        if line.startswith('# '):
            title_text = line[2:].strip()
            story.append(Paragraph(title_text, title_style))
            story.append(Spacer(1, 12))
            
        # Subt√≠tulos (## )
        elif line.startswith('## '):
            subtitle_text = line[3:].strip()
            story.append(Paragraph(subtitle_text, subtitle_style))
            story.append(Spacer(1, 8))
            
        # Subt√≠tulos menores (### )
        elif line.startswith('### '):
            subsubtitle_text = line[4:].strip()
            story.append(Paragraph(f"<b>{subsubtitle_text}</b>", normal_style))
            story.append(Spacer(1, 6))
            
        # Listas con vi√±etas (- )
        elif line.startswith('- ') or line.startswith('* '):
            list_text = line[2:].strip()
            story.append(Paragraph(f"‚Ä¢ {list_text}", normal_style))
            
        # C√≥digo o comandos (`...`)
        elif '`' in line:
            # Simple handling for inline code
            clean_text = line.replace('`', '')
            story.append(Paragraph(f"<font name='Courier'>{clean_text}</font>", normal_style))
            
        # Separadores (---)
        elif line.startswith('---'):
            story.append(Spacer(1, 20))
            story.append(Paragraph("_" * 50, normal_style))
            story.append(Spacer(1, 20))
            
        # Texto normal
        else:
            if line:  # Solo si no est√° vac√≠a
                # Limpiar emojis y caracteres especiales para PDF
                clean_line = line.replace('‚úÖ', '[OK]').replace('‚ùå', '[ERROR]').replace('‚ö†Ô∏è', '[WARNING]')
                clean_line = clean_line.replace('üî¥', '[HIGH]').replace('üü°', '[MEDIUM]').replace('üü¢', '[LOW]')
                clean_line = clean_line.replace('üìä', '[CHART]').replace('üéØ', '[TARGET]').replace('üöÄ', '[ACTION]')
                story.append(Paragraph(clean_line, normal_style))
    
    # Agregar footer con fecha
    footer_style = ParagraphStyle(
        'Footer',
        parent=styles['Normal'],
        fontSize=8,
        alignment=TA_CENTER,
        textColor='#7f8c8d'
    )
    
    story.append(PageBreak())
    story.append(Spacer(1, 200))
    story.append(Paragraph("---", footer_style))
    story.append(Paragraph(f"An√°lisis generado el {datetime.now().strftime('%d/%m/%Y %H:%M')}", footer_style))
    story.append(Paragraph("VoiceFlow PoC - An√°lisis Arquitect√≥nico", footer_style))
    story.append(Paragraph("GitHub Copilot Assistant - Arquitecto de Software", footer_style))
    
    try:
        # Construir PDF
        doc.build(story)
        print(f"‚úÖ PDF generado exitosamente: {output_file}")
        print(f"üìÑ Tama√±o del archivo: {os.path.getsize(output_file) / 1024:.1f} KB")
        return True
        
    except Exception as e:
        print(f"‚ùå Error generando PDF: {e}")
        return False

def main():
    print("üîÑ Generando PDF del an√°lisis arquitect√≥nico...")
    
    if create_pdf_analysis():
        print("üéâ PDF creado exitosamente!")
        print("\nüìñ Para ver el PDF:")
        print("   ‚Ä¢ Windows: start ANALISIS_ARQUITECTONICO_VOICEFLOW_POC.pdf")
        print("   ‚Ä¢ macOS: open ANALISIS_ARQUITECTONICO_VOICEFLOW_POC.pdf") 
        print("   ‚Ä¢ Linux: xdg-open ANALISIS_ARQUITECTONICO_VOICEFLOW_POC.pdf")
    else:
        print("‚ùå No se pudo generar el PDF")
        print("\nüìã Alternativas:")
        print("   ‚Ä¢ El an√°lisis est√° disponible en: ANALISIS_ARQUITECTONICO_COMPLETO.md")
        print("   ‚Ä¢ Usar herramientas online: markdown-pdf.com")
        print("   ‚Ä¢ Instalar pandoc: pandoc ANALISIS_ARQUITECTONICO_COMPLETO.md -o analysis.pdf")

if __name__ == "__main__":
    main()
